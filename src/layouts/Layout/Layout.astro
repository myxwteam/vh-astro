---
const { title, keywords, description, pagecover, activeNav, Home } =
  Astro.props;
// ç½‘ç«™é…ç½®
import SITE_INFO from "@/config";
const { GoogleAds, Theme, HomeBanner } = SITE_INFO;
const { ad_Client, asideAD_Slot, articleAD_Slot } = GoogleAds;
// Head ä¾èµ–
import Head from "@/components/Head/Head.astro";
// é¡¶éƒ¨ Header
import Header from "@/components/Header/Header.astro";
// Main åŒºåŸŸ Header
import MainHeader from "@/components/MainHeader/MainHeader.astro";
// Asideç»„ä»¶
import Aside from "@/components/Aside/Aside.astro";
// åº•éƒ¨ Footer
import Footer from "@/components/Footer/Footer.astro";
// è¿”å›é¡¶éƒ¨
import BackTop from "@/components/BackTop/BackTop.astro";
// æ‰‹æœºç«¯ä¾§è¾¹æ 
import MobileSidebar from "@/components/MobileSidebar/MobileSidebar.astro";
// Live2D çœ‹æ¿å¨˜
import Live2D from "@/components/Live2D.astro";
// A Modern CSS Reset
import "@/styles/Reset.less";
// å…¨å±€åŸºç¡€æ ·å¼
import "@/styles/Base.less";
// Layout æ ·å¼
import "./Layout.less";
---

<html lang="zh-CN">
  <Head
    Title={title}
    Keywords={keywords}
    Description={description}
    PageCover={pagecover}
  >
    <!-- è°·æ­Œå¹¿å‘ŠJSåŠ è½½é¡¹ -->
    {
      ad_Client && (asideAD_Slot || articleAD_Slot) && (
        <script
          is:inline
          async
          src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${ad_Client}`}
          crossorigin="anonymous"
        />
      )
    }
    <!-- å½©æ——ğŸˆ -->
    <script is:inline src="/assets/js/vhCaiqi.js" defer></script>

    <!-- è®¾ç½®ä¸»é¢˜é¢œè‰² -->
    <Fragment
      set:html={`<style>:root {${Object.entries(Theme)
        .map(([key, value]) => `${key}:${value};`)
        .join(
          ""
        )}--vh-main-header-height:${Home ? HomeBanner.HomeHeight : HomeBanner.PageHeight};--vh-home-banner:${HomeBanner.background}}</style>`}
    />
  </Head>
  <body>
    <!-- Live2D çœ‹æ¿å¨˜ -->
    <Live2D />
    <MobileSidebar />
    <Header activeNav={activeNav} />
    <main class="main">
      {HomeBanner.enable && <MainHeader />}
      <section
        class="main-inner"
        style={`padding-top:${HomeBanner.enable ? "0.88rem" : "calc(66px + 0.68rem)"}`}
      >
        <section class="main-inner-content">
          <slot />
        </section>
        <Aside />
      </section>
      <BackTop />
    </main>
    <Footer />
    <script>
      import InitFn from "@/scripts/Init";
      // å…¨å±€åˆå§‹åŒ–
      InitFn();
    </script>
    <!-- Live2D è„šæœ¬åŠ è½½ -->
    <script is:inline>
      window.live2dInitialized = false;
      console.log("Live2D: å‡†å¤‡åŠ è½½è„šæœ¬...");

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = src;
          script.onload = () => {
            console.log("Live2D: å·²åŠ è½½", src);
            resolve();
          };
          script.onerror = () => {
            console.error("Live2D: åŠ è½½å¤±è´¥", src);
            reject(new Error(`Failed to load ${src}`));
          };
          document.head.appendChild(script);
        });
      }

      async function initLive2D() {
        if (window.live2dInitialized) {
          console.log("Live2D: å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡");
          return;
        }

        try {
          console.log("Live2D: å¼€å§‹åŠ è½½...");

          // 0. ç­‰å¾…Live2D HTMLå…ƒç´ å­˜åœ¨
          let waifuElement = document.querySelector(".waifu");
          if (!waifuElement) {
            console.log("Live2D: ç­‰å¾…HTMLå…ƒç´ ...");
            await new Promise((resolve) => {
              const checkElement = setInterval(() => {
                if (document.querySelector(".waifu")) {
                  clearInterval(checkElement);
                  console.log("Live2D: HTMLå…ƒç´ å·²å°±ç»ª");
                  resolve();
                }
              }, 100);
            });
          }

          // 1. åŠ è½½jQuery
          if (typeof jQuery === "undefined") {
            console.log("Live2D: åŠ è½½jQuery...");
            await loadScript(
              "https://cdn.jsdelivr.net/npm/jquery@2.1.4/dist/jquery.min.js"
            );
          }

          // 2. åŠ è½½Live2Dæ ¸å¿ƒåº“ (æœ¬åœ°æ–‡ä»¶)
          if (typeof loadlive2d === "undefined") {
            console.log("Live2D: åŠ è½½Live2Dæ ¸å¿ƒåº“...");
            await loadScript("/2233/js/live2d.js");
          }

          // 3. åŠ è½½waifu-tips
          console.log("Live2D: åŠ è½½waifu-tips...");
          await loadScript("/2233/js/waifu-tips.js");

          window.live2dInitialized = true;
          console.log("Live2D: å…¨éƒ¨åŠ è½½å®Œæˆï¼");
        } catch (error) {
          console.error("Live2DåŠ è½½å¤±è´¥:", error);
        }
      }

      // å¼ºåˆ¶å»¶è¿Ÿæ‰§è¡Œï¼Œä¸ä¾èµ–ä»»ä½•äº‹ä»¶ï¼ˆé¿å…è¢«Swupå¹²æ‰°ï¼‰
      console.log("Live2D: è®¾ç½®å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆ500msï¼‰");
      setTimeout(() => {
        console.log("Live2D: å»¶è¿Ÿæ—¶é—´åˆ°ï¼Œæ‰§è¡Œåˆå§‹åŒ–");
        initLive2D();
      }, 500);

      // å¤‡ç”¨ï¼šå¦‚æœ500mså†…DOMè¿˜æ²¡å‡†å¤‡å¥½ï¼Œå†ç­‰ä¸€ä¼š
      setTimeout(() => {
        if (!window.live2dInitialized) {
          console.log("Live2D: å¤‡ç”¨åˆå§‹åŒ–è§¦å‘ï¼ˆ2000msï¼‰");
          initLive2D();
        }
      }, 2000);
    </script>
  </body>
</html>
